name: Build and Release

on:
  push:
    branches:
      - nightly
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-amd64
            platform: linux
          - os: windows-latest
            name: windows-amd64
            platform: windows
          - os: macos-14
            name: darwin-arm64
            platform: macos
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
      
      - name: Build
        shell: bash
        run: |
          # Extract version from tag or use branch name
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            APP_TITLE="HyPrism - Hytale Launcher"
          elif [[ "${GITHUB_REF}" == refs/heads/nightly ]]; then
            # For nightly builds, use commit short SHA
            VERSION="nightly-$(git rev-parse --short HEAD)"
            APP_TITLE="HyPrism Nightly - Hytale Launcher"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            VERSION="dev-main"
            APP_TITLE="HyPrism Dev - Hytale Launcher"
          else
            VERSION="dev"
            APP_TITLE="HyPrism - Hytale Launcher"
          fi
          
          echo "Building version: $VERSION"
          echo "App title: $APP_TITLE"
          wails build -clean -tags webkit2_41 -ldflags "-X 'HyPrism/app.AppVersion=$VERSION' -X 'HyPrism/app.AppTitle=$APP_TITLE'"
      
      - name: Create DMG (macOS)
        if: matrix.platform == 'macos'
        run: |
          # Install create-dmg
          brew install create-dmg
          
          # Create a clean directory for DMG contents
          mkdir -p dmg-contents
          
          # Move only the .app bundle to dmg-contents
          mv build/bin/HyPrism.app dmg-contents/
          
          # Create a helper script to remove quarantine from Applications
          cat > dmg-contents/Fix-HyPrism.command << 'HELPER'
          #!/bin/bash
          clear
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       HyPrism - Fix macOS Security Warning           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Check common locations for HyPrism.app
          APP_PATH=""
          if [ -d "/Applications/HyPrism.app" ]; then
              APP_PATH="/Applications/HyPrism.app"
          elif [ -d "$HOME/Applications/HyPrism.app" ]; then
              APP_PATH="$HOME/Applications/HyPrism.app"
          elif [ -d "$(dirname "$0")/HyPrism.app" ]; then
              APP_PATH="$(dirname "$0")/HyPrism.app"
          fi
          
          if [ -z "$APP_PATH" ]; then
              echo "âŒ HyPrism.app not found!"
              echo ""
              echo "Please drag HyPrism.app to your Applications folder first,"
              echo "then run this script again."
              echo ""
              echo "Or run manually in Terminal:"
              echo "  xattr -cr /path/to/HyPrism.app"
              echo ""
              read -p "Press Enter to close..."
              exit 1
          fi
          
          echo "Found HyPrism at: $APP_PATH"
          echo ""
          echo "Removing quarantine attribute..."
          xattr -cr "$APP_PATH"
          
          if [ $? -eq 0 ]; then
              echo ""
              echo "âœ… Success! HyPrism is now ready to use."
              echo ""
              echo "You can now open HyPrism from your Applications folder."
          else
              echo ""
              echo "âŒ Failed to remove quarantine. Try running manually:"
              echo "  sudo xattr -cr \"$APP_PATH\""
          fi
          
          echo ""
          read -p "Press Enter to close..."
          HELPER
          chmod +x dmg-contents/Fix-HyPrism.command
          
          # Create DMG from clean directory
          create-dmg \
            --volname "HyPrism" \
            --window-pos 200 120 \
            --window-size 700 400 \
            --icon-size 100 \
            --icon "HyPrism.app" 175 120 \
            --hide-extension "HyPrism.app" \
            --app-drop-link 525 120 \
            --icon "Fix-HyPrism.command" 350 280 \
            "HyPrism-macOS-arm64.dmg" \
            "dmg-contents"
          
          # Clean build/bin and put only DMG there
          rm -rf build/bin/*
          mv HyPrism-macOS-arm64.dmg build/bin/
      
      - name: Create AppImage (Linux)
        if: matrix.platform == 'linux'
        run: |
          # Modern approach: Don't bundle WebKit, just require it as system dependency
          # This is simpler, more reliable, and works better across different distros
          
          # Download appimagetool (latest version)
          wget -q -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # Create AppDir structure
          mkdir -p HyPrism.AppDir/usr/bin
          mkdir -p HyPrism.AppDir/usr/share/applications
          mkdir -p HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps
          mkdir -p HyPrism.AppDir/usr/share/metainfo
          
          # Copy binary
          cp build/bin/HyPrism HyPrism.AppDir/usr/bin/
          chmod +x HyPrism.AppDir/usr/bin/HyPrism

          # Save a copy for Flatpak packaging before we wipe build/bin
          cp build/bin/HyPrism /tmp/HyPrism-binary
          
          # Copy icon at 512x512 for high resolution displays
          convert build/appicon.png -resize 512x512 HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps/hyprism.png || {
            cp build/appicon.png HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps/hyprism.png
          }
          cp HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps/hyprism.png HyPrism.AppDir/hyprism.png
          
          # Create desktop file (must be at root of AppDir)
          cat > HyPrism.AppDir/hyprism.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=HyPrism
          Exec=HyPrism
          Icon=hyprism
          Type=Application
          Categories=Game;
          Terminal=false
          StartupWMClass=HyPrism
          Comment=A modern launcher for Hytale
          DESKTOP
          
          # Copy desktop file to standard location too
          cp HyPrism.AppDir/hyprism.desktop HyPrism.AppDir/usr/share/applications/
          
          # Create AppStream metadata (helps with SteamOS integration)
          cat > HyPrism.AppDir/usr/share/metainfo/hyprism.appdata.xml << 'APPDATA'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>dev.hyprism.HyPrism</id>
            <name>HyPrism</name>
            <summary>A modern launcher for Hytale</summary>
            <metadata_license>MIT</metadata_license>
            <project_license>MIT</project_license>
            <description>
              <p>HyPrism is an open-source, community-driven launcher for Hytale that provides mod management, multiple instances, and more.</p>
            </description>
            <categories>
              <category>Game</category>
            </categories>
          </component>
          APPDATA
          
          # Create simple AppRun - no complex bundling, just use system WebKit
          cat > HyPrism.AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          # Simple AppRun for HyPrism
          
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          
          # Export paths
          export PATH="${HERE}/usr/bin:${PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
          
          # Check if WebKit2GTK 4.1 is available on the system
          if ! ldconfig -p 2>/dev/null | grep -q "libwebkit2gtk-4.1.so.0"; then
            
            # Terminal message (always shown)
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  HyPrism requires WebKit2GTK 4.1                            â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  OPTION 1 (Recommended): Use Flatpak                        â•‘"
            echo "â•‘  Download HyPrism.flatpak from the same release.            â•‘"
            echo "â•‘  It bundles all dependencies - no setup required!           â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  OPTION 2: Install WebKit on your system                    â•‘"
            echo "â•‘  â€¢ Arch:   sudo pacman -S webkit2gtk-4.1                    â•‘"
            echo "â•‘  â€¢ Ubuntu: sudo apt install libwebkit2gtk-4.1-0             â•‘"
            echo "â•‘  â€¢ Fedora: sudo dnf install webkit2gtk4.1                   â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  Note: Most Linux desktops already have WebKit installed    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # GUI dialog with multiple fallbacks
            ERROR_MSG="HyPrism requires WebKit2GTK 4.1 to run.

OPTION 1 (Recommended): Use Flatpak
Download HyPrism.flatpak from the same release.
It bundles all dependencies - no setup required!

OPTION 2: Install WebKit on your system
â€¢ Arch:   sudo pacman -S webkit2gtk-4.1
â€¢ Ubuntu: sudo apt install libwebkit2gtk-4.1-0
â€¢ Fedora: sudo dnf install webkit2gtk4.1

Most Linux desktops already have WebKit installed."
            
            # Try GUI dialogs in order of preference
            if command -v zenity &> /dev/null; then
              zenity --error --title="HyPrism - Missing Dependency" --text="$ERROR_MSG" --width=500 --no-wrap 2>/dev/null || true
            elif command -v kdialog &> /dev/null; then
              kdialog --title "HyPrism - Missing Dependency" --error "$ERROR_MSG" 2>/dev/null || true
            elif command -v xmessage &> /dev/null; then
              xmessage -center -title "HyPrism - Missing Dependency" "$ERROR_MSG" 2>/dev/null || true
            elif command -v notify-send &> /dev/null; then
              notify-send -u critical "HyPrism - Missing Dependency" "WebKit2GTK 4.1 required. Use Flatpak or install webkit2gtk-4.1" 2>/dev/null || true
            fi
            
            # Wait a moment for user to see the message before exiting
            sleep 2
            exit 1
          fi
          
          # Launch HyPrism
          exec "${HERE}/usr/bin/HyPrism" "$@"
          APPRUN
          chmod +x HyPrism.AppDir/AppRun
          
          # Build AppImage with ARCH set
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run HyPrism.AppDir HyPrism-x86_64.AppImage
          
          # Replace binary with AppImage
          rm -rf build/bin/*
          mv HyPrism-x86_64.AppImage build/bin/
          
          # Also create a tar.gz for systems where AppImage doesn't work
          cd HyPrism.AppDir/usr/bin
          tar -czvf ../../../HyPrism-linux-x86_64.tar.gz HyPrism
          cd ../../..
          mv HyPrism-linux-x86_64.tar.gz build/bin/

      - name: Build Flatpak (Linux)
        if: matrix.platform == 'linux'
        run: |
          set -ex
          
          echo "=========================================="
          echo "Starting Flatpak build process"
          echo "=========================================="
          
          # Install Flatpak and flatpak-builder
          echo "Installing Flatpak..."
          sudo apt-get update -qq
          sudo apt-get install -y flatpak flatpak-builder
          
          # Add Flathub remote
          echo "Adding Flathub remote..."
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          
          # Install required runtime with retries
          echo "Installing GNOME Platform 46 (has webkit2gtk-4.1)..."
          for i in 1 2 3; do
            if sudo flatpak install -y --noninteractive flathub org.gnome.Platform//46 org.gnome.Sdk//46; then
              echo "Runtime installed successfully"
              break
            else
              echo "Attempt $i failed, retrying..."
              sleep 5
            fi
          done
          
          # Verify runtime is installed
          echo "Verifying runtime installation..."
          flatpak list | grep org.gnome.Platform
          flatpak list | grep org.gnome.Sdk
          
          # Prepare all files in the flatpak directory
          echo "Preparing files..."
          cp /tmp/HyPrism-binary flatpak/HyPrism
          chmod +x flatpak/HyPrism
          
          # Resize icon to 512x512 for Flatpak (max allowed size)
          echo "Resizing icon to 512x512..."
          convert build/appicon.png -resize 512x512 flatpak/dev.hyprism.HyPrism.png || {
            echo "ImageMagick not found, trying with sips..."
            sips -z 512 512 build/appicon.png --out flatpak/dev.hyprism.HyPrism.png
          }
          
          # Verify all required files exist
          echo "Verifying files..."
          ls -lh flatpak/HyPrism
          ls -lh flatpak/dev.hyprism.HyPrism.png
          ls -lh flatpak/dev.hyprism.HyPrism.desktop
          ls -lh flatpak/dev.hyprism.HyPrism.metainfo.xml
          ls -lh flatpak/dev.hyprism.HyPrism.json
          
          # Test that binary is executable
          file flatpak/HyPrism
          
          # Build the Flatpak
          echo "=========================================="
          echo "Building Flatpak bundle..."
          echo "=========================================="
          cd flatpak
          
          flatpak-builder \
            --force-clean \
            --repo=repo \
            --install-deps-from=flathub \
            builddir \
            dev.hyprism.HyPrism.json
          
          echo "Creating Flatpak bundle..."
          flatpak build-bundle repo HyPrism.flatpak dev.hyprism.HyPrism
          
          # Verify bundle was created and has content
          if [ ! -f HyPrism.flatpak ]; then
            echo "ERROR: Flatpak bundle was not created!"
            exit 1
          fi
          
          BUNDLE_SIZE=$(stat -c%s HyPrism.flatpak 2>/dev/null || stat -f%z HyPrism.flatpak)
          echo "Bundle created successfully: $BUNDLE_SIZE bytes"
          
          if [ "$BUNDLE_SIZE" -lt 1000000 ]; then
            echo "ERROR: Bundle size too small, something went wrong!"
            exit 1
          fi
          
          mv HyPrism.flatpak ../build/bin/
          
          # Verify it was moved
          ls -lh ../build/bin/HyPrism.flatpak
          
          # Clean up
          rm -f HyPrism dev.hyprism.HyPrism.png
          rm -rf repo builddir .flatpak-builder
          
          echo "=========================================="
          echo "Flatpak build completed successfully!"
          echo "=========================================="

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HyPrism-${{ matrix.name }}
          path: build/bin/*
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/nightly'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Flatten artifacts
        run: |
          # Move all files from subdirectories to artifacts root
          find artifacts -type f -mindepth 2 -exec mv {} artifacts/ \;
          # Remove empty subdirectories
          find artifacts -type d -empty -delete
      
      - name: Determine version and release type
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_PRERELEASE="false"
            RELEASE_NAME="v$VERSION"
            TAG_NAME="v$VERSION"
          elif [[ "${GITHUB_REF}" == refs/heads/nightly ]]; then
            VERSION="nightly-$(git rev-parse --short HEAD)"
            IS_PRERELEASE="true"
            RELEASE_NAME="Nightly Build $(date +'%Y-%m-%d')"
            TAG_NAME="nightly"
          else
            VERSION="dev"
            IS_PRERELEASE="true"
            RELEASE_NAME="Development Build"
            TAG_NAME="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Create version.json for auto-updater
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          cat > artifacts/version.json << EOF
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism-x86_64.AppImage",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism-linux-x86_64.tar.gz",
                  "sha256": ""
                },
                "flatpak": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism.flatpak",
                  "sha256": ""
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism.exe",
                  "sha256": ""
                }
              }
            },
            "darwin": {
              "amd64": {
                "launcher": {
                  "url": "",
                  "sha256": ""
                }
              },
              "arm64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism-macOS-arm64.dmg",
                  "sha256": ""
                }
              }
            }
          }
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          name: ${{ steps.version.outputs.release_name }}
          tag_name: ${{ steps.version.outputs.tag_name }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          body: |
            ## HyPrism ${{ steps.version.outputs.release_name }}
            
            ${{ steps.version.outputs.is_prerelease == 'true' && 'âš ï¸ This is a pre-release nightly build for testing.' || 'ðŸŽ‰ Stable release' }}
            
            ### Installation
            - **Windows**: Download `HyPrism.exe`
            - **macOS**: Download `HyPrism-macOS-arm64.dmg`
            - **Linux**: Download `HyPrism.flatpak` (recommended) or `HyPrism-x86_64.AppImage`
            
            ### Changes
            See commit history for details.
