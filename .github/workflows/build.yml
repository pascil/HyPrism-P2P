name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-amd64
            platform: linux
          - os: windows-latest
            name: windows-amd64
            platform: windows
          - os: macos-14
            name: darwin-arm64
            platform: macos
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev
      
      - name: Build
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION="dev"
          fi
          wails build -clean -ldflags "-X 'HyPrism/app.AppVersion=$VERSION'"
      
      - name: Create DMG (macOS)
        if: matrix.platform == 'macos'
        run: |
          # Install create-dmg
          brew install create-dmg
          
          # Create a clean directory for DMG contents
          mkdir -p dmg-contents
          
          # Move only the .app bundle to dmg-contents
          mv build/bin/HyPrism.app dmg-contents/
          
          # Create a helper script to remove quarantine from Applications
          cat > dmg-contents/Fix-HyPrism.command << 'HELPER'
          #!/bin/bash
          clear
          echo ""
          echo "╔══════════════════════════════════════════════════════╗"
          echo "║       HyPrism - Fix macOS Security Warning           ║"
          echo "╚══════════════════════════════════════════════════════╝"
          echo ""
          
          # Check common locations for HyPrism.app
          APP_PATH=""
          if [ -d "/Applications/HyPrism.app" ]; then
              APP_PATH="/Applications/HyPrism.app"
          elif [ -d "$HOME/Applications/HyPrism.app" ]; then
              APP_PATH="$HOME/Applications/HyPrism.app"
          elif [ -d "$(dirname "$0")/HyPrism.app" ]; then
              APP_PATH="$(dirname "$0")/HyPrism.app"
          fi
          
          if [ -z "$APP_PATH" ]; then
              echo "❌ HyPrism.app not found!"
              echo ""
              echo "Please drag HyPrism.app to your Applications folder first,"
              echo "then run this script again."
              echo ""
              echo "Or run manually in Terminal:"
              echo "  xattr -cr /path/to/HyPrism.app"
              echo ""
              read -p "Press Enter to close..."
              exit 1
          fi
          
          echo "Found HyPrism at: $APP_PATH"
          echo ""
          echo "Removing quarantine attribute..."
          xattr -cr "$APP_PATH"
          
          if [ $? -eq 0 ]; then
              echo ""
              echo "✅ Success! HyPrism is now ready to use."
              echo ""
              echo "You can now open HyPrism from your Applications folder."
          else
              echo ""
              echo "❌ Failed to remove quarantine. Try running manually:"
              echo "  sudo xattr -cr \"$APP_PATH\""
          fi
          
          echo ""
          read -p "Press Enter to close..."
          HELPER
          chmod +x dmg-contents/Fix-HyPrism.command
          
          # Create DMG from clean directory
          create-dmg \
            --volname "HyPrism" \
            --window-pos 200 120 \
            --window-size 700 400 \
            --icon-size 100 \
            --icon "HyPrism.app" 175 120 \
            --hide-extension "HyPrism.app" \
            --app-drop-link 525 120 \
            --icon "Fix-HyPrism.command" 350 280 \
            "HyPrism-macOS-arm64.dmg" \
            "dmg-contents"
          
          # Clean build/bin and put only DMG there
          rm -rf build/bin/*
          mv HyPrism-macOS-arm64.dmg build/bin/
      
      - name: Create AppImage (Linux)
        if: matrix.platform == 'linux'
        run: |
          # Download appimagetool
          wget -q -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # Create AppDir structure
          mkdir -p HyPrism.AppDir/usr/bin
          mkdir -p HyPrism.AppDir/usr/lib
          mkdir -p HyPrism.AppDir/usr/share/applications
          mkdir -p HyPrism.AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p HyPrism.AppDir/usr/share/metainfo
          
          # Copy binary
          cp build/bin/HyPrism HyPrism.AppDir/usr/bin/
          chmod +x HyPrism.AppDir/usr/bin/HyPrism
          
          # Copy icon
          cp build/appicon.png HyPrism.AppDir/usr/share/icons/hicolor/256x256/apps/hyprism.png
          cp build/appicon.png HyPrism.AppDir/hyprism.png
          
          # Create desktop file (must be at root of AppDir)
          cat > HyPrism.AppDir/hyprism.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=HyPrism
          Exec=HyPrism
          Icon=hyprism
          Type=Application
          Categories=Game;
          Terminal=false
          StartupWMClass=HyPrism
          Comment=A modern launcher for Hytale
          DESKTOP
          
          # Copy desktop file to standard location too
          cp HyPrism.AppDir/hyprism.desktop HyPrism.AppDir/usr/share/applications/
          
          # Create AppStream metadata (helps with SteamOS integration)
          cat > HyPrism.AppDir/usr/share/metainfo/hyprism.appdata.xml << 'APPDATA'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>dev.hyprism.HyPrism</id>
            <name>HyPrism</name>
            <summary>A modern launcher for Hytale</summary>
            <metadata_license>MIT</metadata_license>
            <project_license>MIT</project_license>
            <description>
              <p>HyPrism is an open-source, community-driven launcher for Hytale that provides mod management, multiple instances, and more.</p>
            </description>
            <categories>
              <category>Game</category>
            </categories>
          </component>
          APPDATA
          
          # Bundle required WebKit2GTK libraries for systems without them
          # Copy critical libraries that might be missing on SteamOS
          for lib in libwebkit2gtk-4.0.so.37 libjavascriptcoregtk-4.0.so.18; do
            if [ -f "/usr/lib/x86_64-linux-gnu/$lib" ]; then
              cp "/usr/lib/x86_64-linux-gnu/$lib" HyPrism.AppDir/usr/lib/ 2>/dev/null || true
            fi
          done
          
          # Create AppRun with better environment setup for SteamOS compatibility
          cat > HyPrism.AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          # AppRun script for HyPrism with SteamOS compatibility
          
          set -e
          
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          
          # Add our bundled binaries and libraries to path
          export PATH="${HERE}/usr/bin:${PATH}"
          
          # Add bundled libraries with proper fallback
          if [ -d "${HERE}/usr/lib" ]; then
            export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          fi
          
          # Handle XDG directories for proper file access
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
          
          # Fix for some GPU drivers on SteamOS
          export WEBKIT_DISABLE_COMPOSITING_MODE="${WEBKIT_DISABLE_COMPOSITING_MODE:-0}"
          
          # Launch the application
          cd "${HERE}/usr/bin"
          exec ./HyPrism "$@"
          APPRUN
          chmod +x HyPrism.AppDir/AppRun
          
          # Build AppImage with ARCH set and extract-and-run for compatibility
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run HyPrism.AppDir HyPrism-x86_64.AppImage
          
          # Save the binary before cleaning build/bin
          cp HyPrism.AppDir/usr/bin/HyPrism /tmp/HyPrism-binary
          
          # Replace binary with AppImage
          rm -rf build/bin/*
          mv HyPrism-x86_64.AppImage build/bin/
          
          # Also create a tar.gz for systems where AppImage doesn't work
          cd HyPrism.AppDir/usr/bin
          tar -czvf ../../../HyPrism-linux-x86_64.tar.gz HyPrism
          cd ../../..
          mv HyPrism-linux-x86_64.tar.gz build/bin/

      - name: Build Flatpak (Linux)
        if: matrix.platform == 'linux'
        run: |
          set -ex
          
          echo "=========================================="
          echo "Starting Flatpak build process"
          echo "=========================================="
          
          # Install Flatpak and flatpak-builder
          echo "Installing Flatpak..."
          sudo apt-get update -qq
          sudo apt-get install -y flatpak flatpak-builder
          
          # Add Flathub remote
          echo "Adding Flathub remote..."
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          
          # Install required runtime with retries
          echo "Installing GNOME Platform 47 and Nickvision base (for webkit2gtk-4.0)..."
          for i in 1 2 3; do
            if sudo flatpak install -y --noninteractive flathub org.gnome.Platform//47 org.gnome.Sdk//47 org.nickvision.base//47; then
              echo "Runtime installed successfully"
              break
            else
              echo "Attempt $i failed, retrying..."
              sleep 5
            fi
          done
          
          # Verify runtime is installed
          echo "Verifying runtime installation..."
          flatpak list | grep org.gnome.Platform
          flatpak list | grep org.gnome.Sdk
          flatpak list | grep org.nickvision.base || echo "Nickvision base not found (optional)"
          
          # Prepare all files in the flatpak directory
          echo "Preparing files..."
          cp /tmp/HyPrism-binary flatpak/HyPrism
          chmod +x flatpak/HyPrism
          
          # Resize icon to 512x512 for Flatpak (max allowed size)
          echo "Resizing icon to 512x512..."
          convert build/appicon.png -resize 512x512 flatpak/dev.hyprism.HyPrism.png || {
            echo "ImageMagick not found, trying with sips..."
            sips -z 512 512 build/appicon.png --out flatpak/dev.hyprism.HyPrism.png
          }
          
          # Verify all required files exist
          echo "Verifying files..."
          ls -lh flatpak/HyPrism
          ls -lh flatpak/dev.hyprism.HyPrism.png
          ls -lh flatpak/dev.hyprism.HyPrism.desktop
          ls -lh flatpak/dev.hyprism.HyPrism.metainfo.xml
          ls -lh flatpak/dev.hyprism.HyPrism.json
          
          # Test that binary is executable
          file flatpak/HyPrism
          
          # Build the Flatpak
          echo "=========================================="
          echo "Building Flatpak bundle..."
          echo "=========================================="
          cd flatpak
          
          flatpak-builder \
            --force-clean \
            --repo=repo \
            --install-deps-from=flathub \
            builddir \
            dev.hyprism.HyPrism.json
          
          echo "Creating Flatpak bundle..."
          flatpak build-bundle repo HyPrism.flatpak dev.hyprism.HyPrism
          
          # Verify bundle was created and has content
          if [ ! -f HyPrism.flatpak ]; then
            echo "ERROR: Flatpak bundle was not created!"
            exit 1
          fi
          
          BUNDLE_SIZE=$(stat -c%s HyPrism.flatpak 2>/dev/null || stat -f%z HyPrism.flatpak)
          echo "Bundle created successfully: $BUNDLE_SIZE bytes"
          
          if [ "$BUNDLE_SIZE" -lt 1000000 ]; then
            echo "ERROR: Bundle size too small, something went wrong!"
            exit 1
          fi
          
          mv HyPrism.flatpak ../build/bin/
          
          # Verify it was moved
          ls -lh ../build/bin/HyPrism.flatpak
          
          # Clean up
          rm -f HyPrism dev.hyprism.HyPrism.png
          rm -rf repo builddir .flatpak-builder
          
          echo "=========================================="
          echo "Flatpak build completed successfully!"
          echo "=========================================="

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HyPrism-${{ matrix.name }}
          path: build/bin/*
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Flatten artifacts
        run: |
          # Move all files from subdirectories to artifacts root
          find artifacts -type f -mindepth 2 -exec mv {} artifacts/ \;
          # Remove empty subdirectories
          find artifacts -type d -empty -delete
      
      - name: Create version.json for auto-updater
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          cat > artifacts/version.json << EOF
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/v$VERSION/HyPrism-x86_64.AppImage",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/v$VERSION/HyPrism-linux-x86_64.tar.gz",
                  "sha256": ""
                },
                "flatpak": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/v$VERSION/HyPrism.flatpak",
                  "sha256": ""
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/v$VERSION/HyPrism.exe",
                  "sha256": ""
                }
              }
            },
            "darwin": {
              "amd64": {
                "launcher": {
                  "url": "",
                  "sha256": ""
                }
              },
              "arm64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/v$VERSION/HyPrism-macOS-arm64.dmg",
                  "sha256": ""
                }
              }
            }
          }
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
